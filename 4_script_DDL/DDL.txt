/* ============================================================ */
/* SCRIPT DDL POSTGRESQL - PROJET BiblioTHECH                   */
/* Date : 28/01/2026                                            */
/* ============================================================ */

/*______NETTOYAGE (Ordre inverse des dépendances)*/
DROP TABLE IF EXISTS PARTICIPE CASCADE;
DROP TABLE IF EXISTS EVENT CASCADE;
DROP TABLE IF EXISTS TRANSFERT CASCADE;
DROP TABLE IF EXISTS SUGGERE CASCADE;
DROP TABLE IF EXISTS RESERVE CASCADE;
DROP TABLE IF EXISTS EMPRUNTE CASCADE;
DROP TABLE IF EXISTS ABONNE CASCADE;
DROP TABLE IF EXISTS TYPE_ABONNEMENT CASCADE;
DROP TABLE IF EXISTS EXEMPLAIRE CASCADE;
DROP TABLE IF EXISTS CATALOGUE CASCADE;
DROP TABLE IF EXISTS ECRIT CASCADE;
DROP TABLE IF EXISTS OUVRAGE CASCADE;
DROP TABLE IF EXISTS AUTEUR CASCADE;
DROP TABLE IF EXISTS CATEGORIE CASCADE;
DROP TABLE IF EXISTS EST_DISTANT CASCADE;
DROP TABLE IF EXISTS BIBLIOTHEQUE CASCADE;
DROP TABLE IF EXISTS REGION CASCADE;

/* ====================================== */
/* 1 : ZONES GEOGRAPHIQUES ET LIEUX       */
/* ====================================== */

CREATE TABLE REGION (
    id_region SERIAL PRIMARY KEY,
    nom_region VARCHAR(50) NOT NULL
);

CREATE TABLE BIBLIOTHEQUE (
    id_biblio SERIAL PRIMARY KEY,
    nom VARCHAR(100) NOT NULL,
    adresse VARCHAR(255) NOT NULL,
    id_region INT NOT NULL,
    FOREIGN KEY (id_region) REFERENCES REGION(id_region)
);

CREATE TABLE EST_DISTANT (
    id_biblio_A INT NOT NULL,
    id_biblio_B INT NOT NULL,
    temps_transport INT NOT NULL, -- En minutes
    PRIMARY KEY (id_biblio_A, id_biblio_B),
    FOREIGN KEY (id_biblio_A) REFERENCES BIBLIOTHEQUE(id_biblio),
    FOREIGN KEY (id_biblio_B) REFERENCES BIBLIOTHEQUE(id_biblio),
    CHECK (id_biblio_A != id_biblio_B)
);

/* ====================================== */
/* 2 : CATALOGUE ET OUVRAGES              */
/* ====================================== */

CREATE TABLE CATEGORIE (
    id_cat SERIAL PRIMARY KEY,
    libelle_genre VARCHAR(50) NOT NULL
);

CREATE TABLE AUTEUR (
    id_auteur SERIAL PRIMARY KEY,
    nom VARCHAR(100) NOT NULL
);

CREATE TABLE OUVRAGE (
    id_ouvrage SERIAL PRIMARY KEY,
    titre VARCHAR(255) NOT NULL,
    type_support VARCHAR(50) NOT NULL,
    compteur_demande_achat INT DEFAULT 0,
    seuil_achat INT DEFAULT 5,
    id_cat INT NOT NULL,
    FOREIGN KEY (id_cat) REFERENCES CATEGORIE(id_cat)
);

CREATE TABLE ECRIT (
    id_auteur INT NOT NULL,
    id_ouvrage INT NOT NULL,
    PRIMARY KEY (id_auteur, id_ouvrage),
    FOREIGN KEY (id_auteur) REFERENCES AUTEUR(id_auteur),
    FOREIGN KEY (id_ouvrage) REFERENCES OUVRAGE(id_ouvrage)
);

/* Catalogue logique : Une biblio référence un titre */
CREATE TABLE CATALOGUE (
    id_ouvrage INT NOT NULL,
    id_biblio INT NOT NULL,
    PRIMARY KEY (id_ouvrage, id_biblio),
    FOREIGN KEY (id_ouvrage) REFERENCES OUVRAGE(id_ouvrage),
    FOREIGN KEY (id_biblio) REFERENCES BIBLIOTHEQUE(id_biblio)
);

/* ====================================== */
/* 3 : STOCK PHYSIQUE                     */
/* ====================================== */

CREATE TABLE EXEMPLAIRE (
    code_barre VARCHAR(50) PRIMARY KEY,
    etage VARCHAR(20),
    rayon VARCHAR(20),
    etat VARCHAR(50),
    date_achat DATE,
    id_ouvrage INT NOT NULL,
    id_biblio INT NOT NULL,
    FOREIGN KEY (id_ouvrage) REFERENCES OUVRAGE(id_ouvrage),
    FOREIGN KEY (id_biblio) REFERENCES BIBLIOTHEQUE(id_biblio)
);

/* ====================================== */
/* 4. ABONNES                             */
/* ====================================== */

CREATE TABLE TYPE_ABONNEMENT (
    id_type SERIAL PRIMARY KEY,
    libelle VARCHAR(50) NOT NULL,
    quota_max INT NOT NULL,
    duree_pret_max INT NOT NULL -- En jours
);

CREATE TABLE ABONNE (
    id_abonne SERIAL PRIMARY KEY,
    nom VARCHAR(100) NOT NULL,
    prenom VARCHAR(100) NOT NULL,
    date_inscription DATE NOT NULL,
    est_bloque BOOLEAN DEFAULT FALSE,
    fin_blocage DATE DEFAULT NULL,
    id_type INT NOT NULL,
    FOREIGN KEY (id_type) REFERENCES TYPE_ABONNEMENT(id_type)
);

/* ====================================== */
/* 5. PRETS, RESERVATIONS ET SUGGESTIONS  */
/* ====================================== */

CREATE TABLE EMPRUNTE (
    id_emprunt SERIAL PRIMARY KEY,
    date_emprunt TIMESTAMP NOT NULL,
    date_retour_prevue DATE NOT NULL,
    date_retour_effectif TIMESTAMP DEFAULT NULL,
    est_prolonge BOOLEAN DEFAULT FALSE,
    id_abonne INT NOT NULL,
    code_barre VARCHAR(50) NOT NULL,
    FOREIGN KEY (id_abonne) REFERENCES ABONNE(id_abonne),
    FOREIGN KEY (code_barre) REFERENCES EXEMPLAIRE(code_barre)
);

CREATE TABLE RESERVE (
    id_ouvrage INT NOT NULL,
    id_abonne INT NOT NULL,
    id_biblio INT NOT NULL, -- Bibliothèque de retrait
    date_demande TIMESTAMP NOT NULL,
    PRIMARY KEY (id_ouvrage, id_abonne, id_biblio),
    FOREIGN KEY (id_ouvrage) REFERENCES OUVRAGE(id_ouvrage),
    FOREIGN KEY (id_abonne) REFERENCES ABONNE(id_abonne),
    FOREIGN KEY (id_biblio) REFERENCES BIBLIOTHEQUE(id_biblio)
);

CREATE TABLE SUGGERE (
    id_abonne INT NOT NULL,
    id_ouvrage INT NOT NULL,
    date_suggestion DATE NOT NULL,
    PRIMARY KEY (id_abonne, id_ouvrage),
    FOREIGN KEY (id_abonne) REFERENCES ABONNE(id_abonne),
    FOREIGN KEY (id_ouvrage) REFERENCES OUVRAGE(id_ouvrage)
);

/* ====================================== */
/* 6. LOGISTIQUE ET EVENEMENTS            */
/* ====================================== */

CREATE TABLE TRANSFERT (
    id_transfert SERIAL PRIMARY KEY,
    statut VARCHAR(50) NOT NULL,
    date_depart TIMESTAMP,
    date_arrivee TIMESTAMP DEFAULT NULL,
    id_biblio_expediteur INT NOT NULL,
    id_biblio_receveur INT NOT NULL,
    code_barre VARCHAR(50) NOT NULL,
    FOREIGN KEY (id_biblio_expediteur) REFERENCES BIBLIOTHEQUE(id_biblio),
    FOREIGN KEY (id_biblio_receveur) REFERENCES BIBLIOTHEQUE(id_biblio),
    FOREIGN KEY (code_barre) REFERENCES EXEMPLAIRE(code_barre)
);

CREATE TABLE EVENT (
    id_event SERIAL PRIMARY KEY,
    nom VARCHAR(100) NOT NULL,
    date_event TIMESTAMP NOT NULL,
    capacite INT NOT NULL,
    nb_inscrits INT DEFAULT 0,
    type_event VARCHAR(50),
    id_biblio INT NOT NULL,
    FOREIGN KEY (id_biblio) REFERENCES BIBLIOTHEQUE(id_biblio)
);

CREATE TABLE PARTICIPE (
    id_abonne INT NOT NULL,
    id_event INT NOT NULL,
    PRIMARY KEY (id_abonne, id_event),
    FOREIGN KEY (id_abonne) REFERENCES ABONNE(id_abonne),
    FOREIGN KEY (id_event) REFERENCES EVENT(id_event)
);

/* ====================================== */
/* Ajout des commentaires  pour les unitées de mesures qui ne sont pas implicites */
/* ====================================== */
COMMENT ON COLUMN EST_DISTANT.temps_transport IS 'Temps en minutes';
COMMENT ON COLUMN TYPE_ABONNEMENT.duree_pret_max IS 'Durée en jours';
COMMENT ON COLUMN RESERVE.id_biblio IS 'Bibliothèque de retrait';